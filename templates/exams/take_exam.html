{% extends '_base.html' %}
{% load static %}

{% block title %}Exam{% endblock title %}

{% block content %}
<div class="container">
    
    <h6>{{ exam.name }}</h6>

    <p id="countdown" style="float: right; color: red;">Time left.</p>

        <p class="lead" id="question-text">{{ question.text }}</p>


        <form id="exam-form">
            {% csrf_token %}
            <div class="form-check">
                {% for choice in question.choices.all %}

                <label class="form-check-label" for="choice{{ choice.id }}">{{ choice.text }}</label>
                <input class="form-check-input" id="choice{{ choice.id }}" type="radio" name="user_choice" value="{{ choice.id }}">
                <br>
                
    
                {% endfor %}
                <input class="btn btn-primary m-2" type="submit" value="Next question">
            </div>

        </form>

</div>

<script>

    const form = document.getElementById('exam-form');
    const hidden = form.querySelector('[name=csrfmiddlewaretoken]');
    const csrftoken = hidden.value;

    function nextQuestion(question){
        var form = document.getElementById('exam-form');
        var questionEl = document.getElementById('question-text')

        questionEl.innerHTML = question["text"]
        form.innerHTML = "";

        form.appendChild(hidden)

        var choiceDiv = document.createElement('div');
        choiceDiv.className = "form-check";

        choices = question["choices"]
        choices.forEach(function(choice){
            console.log(choice)
            const input = document.createElement('input');
            input.id = `choice${choice["id"]}`;
            input.type = 'radio';
            input.name = "user_choice"
            input.value = choice["id"]
            input.className = "form-check-input";

            const label = document.createElement('label');
            label.setAttribute('for', `choice${choice["id"]}`)
            label.textContent = choice["text"];
            label.className = "form-check-label";

            br = document.createElement('br')
            choiceDiv.appendChild(label);
            choiceDiv.appendChild(input);
            choiceDiv.appendChild(br)
            
        })

        const submit = document.createElement('input');
        submit.className = 'btn btn-primary m2'
        submit.type = 'submit';
        submit.value = 'Next question';

        choiceDiv.appendChild(submit)
        
        form.appendChild(choiceDiv)
        console.log(form);

    }

    form.addEventListener('submit', event =>{
        event.preventDefault();

        const formData = new FormData(form);
        const data = new URLSearchParams(formData);

        fetch("{% url 'take-exam' exam.uuid %}", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                "X-CSRFToken": csrftoken
            },
            body: data
        }).then(response => response.json()).then(data =>{

            if (data["complete"] === true) {
                console.log("Redirected by Javascript!")
                window.location.href = "{% url 'exam-complete' %}";
            }
            else {
                console.log("Data recieved. Inside of fetch method:")
                console.log(data)
                nextQuestion(data);
            };

            
            
        })
    });
    
    function startCountdown() {
        // Calculate the end time (2 hours from now)
        const endTime = new Date();
        endTime.setTime(endTime.getTime() + 100000); // 2 hours in milliseconds
      
        // Update the countdown every second
        const timerInterval = setInterval(function() {
          const currentTime = new Date().getTime();
          const timeLeft = endTime - currentTime;
      
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            console.log("Countdown timer has ended!");
            document.getElementById("countdown").innerHTML = "Time ended. Redirecting..."
            setTimeout(function(){
                return  window.location.href = "{% url 'exam-complete' %}"
            }, 2000)

          } else {
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            document.getElementById("countdown").innerHTML = hours + "h " + minutes + "m " + String(seconds) + "s";

            console.log(`Time left: ${hours} hours ${minutes} seconds ${seconds}`);
          }
        }, 1000); // Update every 1 second
      }
      
      // Call the function to start the countdown
      startCountdown();
</script>

{% endblock content %}